<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Automating Deployment using Jenkins,Ansible and AWS | Malek Zaag</title>
<meta name="keywords" content="Kubernetes, AWS, Automation, Jenkins, Ci Cd pipeline">
<meta name="description" content="In this blog, we&#39;ll discuss how to set up a CI/CD pipeline using Jenkins and Argo CD. ">
<meta name="author" content="">
<link rel="canonical" href="https://malek-zaag.netlify.app/blog/aws-automated-pipeline/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.a72801f0f40a8d7f71aa1cafd1c2f2a993a1f26ca1cfd38fdba65d5b9b0f08a0.css" integrity="sha256-pygB8PQKjX9xqhyv0cLyqZOh8myhz9OP26ZdW5sPCKA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.5b9ae0304f93db6cc493f51846f012428af399c614b4f2fbdb7fa59dd4d5ef5b.js" integrity="sha256-W5rgME&#43;T22zEk/UYRvASQorzmcYUtPL723&#43;lndTV71s="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://malek-zaag.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://malek-zaag.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://malek-zaag.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://malek-zaag.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://malek-zaag.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Automating Deployment using Jenkins,Ansible and AWS" />
<meta property="og:description" content="In this blog, we&#39;ll discuss how to set up a CI/CD pipeline using Jenkins and Argo CD. " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malek-zaag.netlify.app/blog/aws-automated-pipeline/" />
<meta property="og:image" content="https://malek-zaag.netlify.app/blog/aws-automated-pipeline/1.jpg" /><meta property="article:section" content="blog" />



<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://malek-zaag.netlify.app/blog/aws-automated-pipeline/1.jpg" />
<meta name="twitter:title" content="Automating Deployment using Jenkins,Ansible and AWS"/>
<meta name="twitter:description" content="In this blog, we&#39;ll discuss how to set up a CI/CD pipeline using Jenkins and Argo CD. "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://malek-zaag.netlify.app/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Automating Deployment using Jenkins,Ansible and AWS",
      "item": "https://malek-zaag.netlify.app/blog/aws-automated-pipeline/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Automating Deployment using Jenkins,Ansible and AWS",
  "name": "Automating Deployment using Jenkins,Ansible and AWS",
  "description": "In this blog, we'll discuss how to set up a CI/CD pipeline using Jenkins and Argo CD. ",
  "keywords": [
    "Kubernetes", "AWS", "Automation", "Jenkins", "Ci Cd pipeline"
  ],
  "articleBody": "In today‚Äôs fast-paced software development environment, the efficient and reliable deployment of applications is crucial. A Continuous Integration/Continuous Deployment (CI/CD) pipeline plays a pivotal role in automating and streamlining the software development lifecycle. This pipeline integrates Jenkins, Ansible, and cloud services from AWS and Azure to deliver a comprehensive solution for your software deployment needs.\nIn this article, we will demonstrate the following :\nThe Web Application will be deployed using python Flask framework.\nThe Web Application should be accessible via web browser from anywhere on port 4000.\nEC2‚Äôs and their security groups should be created on AWS console with Terraform.\nThe rest of the process has to be controlled with control node which is connected SSH port.\nPostgreSQL and Flask App should be running in containers\nWe are going to use AWS ECR as an image repository, to create Docker Containers with 2 managed nodes (postgresql and Flask instances).\nProject GitHub Repo: https://github.com/Malek-Zaag/Automation-pipeline-with-Ansible-and-AWS\nProject Requirements and architecture : Virtual machine for all the workload (Azure VM)\n2 Virtual machines for application (Flask) and postgresql as docker images\nAnsible\nAWS CLI to fetch images from AWS ECR\nCoding The application: Our application is a simple python Flask application that has a default route, add_book route and a delete route.\n@app.route('/') def index(): books = Book.query.all() return render_template('index.html', books=books) @app.route('/add_book', methods=['POST','GET']) def add_book(): if request.method == 'POST': title = request.form['title'] author = request.form['author'] publication_date = request.form['publication_date'] book = Book(title=title, author=author, publication_date=publication_date) db.session.add(book) db.session.commit() return redirect(url_for('index')) elif request.method =='GET': return render_template('form.html') @app.route('/delete_book/') def delete_book(id): book = Book.query.get(id) db.session.delete(book) db.session.commit() return redirect(url_for('index'))py Creating custom Postgres docker image: As we want to have a custom user and password for our database, we opted for a building a new docker image for it and it creates a table called books and has persistent volumes for our data.\nFROM postgres:12.16-bullseye\rENV POSTGRES_USER=admin\rENV POSTGRES_PASSWORD=admin\rENV POSTGRES_HOST=localhost\rVOLUME [ \"/var/lib/postgresql/data\" ]\rWORKDIR /\rCOPY init.sql /docker-entrypoint-initdb.d/\rEXPOSE 5432do\rInit.sql:\nCREATE TABLE book ( id SERIAL PRIMARY KEY, title VARCHAR(255), author VARCHAR(255), publication_date DATE );\rAfter starting our containers, the application is working fine on our local machine :\nWriting Infrastructure manifest : As we mentioned earlier, we will be provisioning a jenkins server and it will be also operating as ansible admin server.\nFinished writing infrastructure manifests :\nNow it is time to provision the jenkins main server which will execute our pipeline, for that i used also the IAC approach :\nterraform apply - auto-approve - var-file=terraform.tfvars\rNow it is time to setup the jenkins server and install the appropriate plugins :\nWe need to setup our AWS access tokens in the machine so it can apply the manifest files:\nConfiguring aws ECR : Amazon Elastic Container Registry (Amazon ECR) is a fully managed container registry offering high-performance hosting, so you can reliably deploy application images and artifacts anywhere.\nWe create the private repository :\nPushign images to ECR : To push our local images to the repository that we have previously created, we need to tag the image like the following :\nDocker tag local_image_name repo_name:local_image\rDatabase :\nNow for ansible to connect to machine, we need to copy the private key to the jenkins server :\nOne more thing we needed to do is copying manually the vars.yaml file from our machine to the jenkins server because it contains vulnerable credentials and it cannot be pushed to git:\nAfter a lot of troubleshooting and tweaking of the ansible playbook, our pipeline executed successfully :\nOur playbook consists of installing required packages, installing docker and aws cli, and finally connecting docker to our private repository :\nWe can now access our Flask application located on the first machine, it seems working perfectly :\nBefore closing up, i want to explain a stage in our pipeline :\nstage(\"Adding public IPs to /etc/hosts\") {\rsteps {\rdir(\"./Infrastructure/EC2/\") {\rsh \"terraform output \u003e file.txt\"\rsh \"cut -d '=' -f 2 file.txt\"\rsh \"sed 's/\\\"//g; s/=//g' file.txt \u003e res.txt\"\rsh 'awk \\' { t = $1; $1 = $2; $2 = t; print; } \\' res.txt \u003e f.txt'\rsh \"cat f.txt\"\rsh 'sudo -- sh -c \"cat f.txt \u003e\u003e /etc/hosts\"'\r}\r}\r}\rThis little script takes the two ip addresses of the EC2s from the terraform output and it concatenates them into /etc/hosts file as :\nip_address hostname\rSo ansible can resolve ip-one and ip-two to their correct addresses.\nWas this helpful?\nConfusing?\nIf you have any questions, feel free to comment below!\nBefore you leave:\nüëè Clap for the story\nüì∞ Subscribe for more posts like this @malek.zaag ‚ö°Ô∏è\nüëâüëà Please follow me: GitHub | LinkedIn\n",
  "wordCount" : "769",
  "inLanguage": "en",
  "image":"https://malek-zaag.netlify.app/blog/aws-automated-pipeline/1.jpg","datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://malek-zaag.netlify.app/blog/aws-automated-pipeline/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Malek Zaag",
    "logo": {
      "@type": "ImageObject",
      "url": "https://malek-zaag.netlify.app/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    <nav class="nav">
        <div class="logo">
            <a href="https://malek-zaag.netlify.app/" accesskey="h" title="Malek Zaag (Alt + H)">Malek Zaag</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://malek-zaag.netlify.app/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://malek-zaag.netlify.app/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://malek-zaag.netlify.app/projects" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://malek-zaag.netlify.app/experience" title="Experience">
                    <span>Experience</span>
                </a>
            </li>
            <li>
                <a href="https://malek-zaag.netlify.app/certifications" title="Certifications">
                    <span>Certifications</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://malek-zaag.netlify.app/">Home</a>&nbsp;¬ª&nbsp;<a href="https://malek-zaag.netlify.app/blog/">Blogs</a></div>
    <h1 class="post-title">
      Automating Deployment using Jenkins,Ansible and AWS
    </h1>
    <div class="post-description">
      In this blog, we&#39;ll discuss how to set up a CI/CD pipeline using Jenkins and Argo CD. 
    </div>
    <div class="post-meta">


Dec 2022

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://malek-zaag.netlify.app/blog/aws-automated-pipeline/1.jpg" alt="">
        
</figure>
  <div class="post-content"><p>In today&rsquo;s fast-paced software development environment, the efficient and reliable deployment of applications is crucial. A Continuous Integration/Continuous Deployment (CI/CD) pipeline plays a pivotal role in automating and streamlining the software development lifecycle. This pipeline integrates Jenkins, Ansible, and cloud services from AWS and Azure to deliver a comprehensive solution for your software deployment needs.</p>
<p>In this article, we will demonstrate the following :</p>
<ul>
<li>
<p>The Web Application will be deployed using python Flask framework.</p>
</li>
<li>
<p>The Web Application should be accessible via web browser from anywhere on port 4000.</p>
</li>
<li>
<p>EC2&rsquo;s and their security groups should be created on AWS console with Terraform.</p>
</li>
<li>
<p>The rest of the process has to be controlled with control node which is connected SSH port.</p>
</li>
<li>
<p>PostgreSQL and Flask App should be running in containers</p>
</li>
<li>
<p>We are going to use AWS ECR as an image repository, to create Docker Containers with 2 managed nodes (postgresql and Flask instances).</p>
</li>
</ul>
<p>Project GitHub Repo: <a href="https://github.com/Malek-Zaag/Automation-pipeline-with-Ansible-and-AWS">https://github.com/Malek-Zaag/Automation-pipeline-with-Ansible-and-AWS</a></p>
<h3 id="project-requirements-and-architecture-">Project Requirements and architecture :<a hidden class="anchor" aria-hidden="true" href="#project-requirements-and-architecture-">#</a></h3>
<ul>
<li>
<p>Virtual machine for all the workload (Azure VM)</p>
</li>
<li>
<p>2 Virtual machines for application (Flask) and postgresql as docker images</p>
</li>
<li>
<p>Ansible</p>
</li>
<li>
<p>AWS CLI to fetch images from AWS ECR</p>
</li>
</ul>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*ZOOHua7PkbsDLKI_" alt=""  />
</p>
<h3 id="coding-the-application">Coding The application:<a hidden class="anchor" aria-hidden="true" href="#coding-the-application">#</a></h3>
<p>Our application is a simple python Flask application that has a default route, add_book route and a delete route.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>        books <span style="color:#f92672">=</span> Book<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>, books<span style="color:#f92672">=</span>books)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/add_book&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>,<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_book</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>            title <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;title&#39;</span>]
</span></span><span style="display:flex;"><span>            author <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;author&#39;</span>]
</span></span><span style="display:flex;"><span>            publication_date <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;publication_date&#39;</span>]
</span></span><span style="display:flex;"><span>            book <span style="color:#f92672">=</span> Book(title<span style="color:#f92672">=</span>title, author<span style="color:#f92672">=</span>author, publication_date<span style="color:#f92672">=</span>publication_date)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(book)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;index&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;form.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/delete_book/&lt;int:id&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_book</span>(id):
</span></span><span style="display:flex;"><span>        book <span style="color:#f92672">=</span> Book<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>get(id)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>delete(book)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;index&#39;</span>))py
</span></span></code></pre></div><h3 id="creating-custom-postgres-docker-image">Creating custom Postgres docker image:<a hidden class="anchor" aria-hidden="true" href="#creating-custom-postgres-docker-image">#</a></h3>
<p>As we want to have a custom user and password for our database, we opted for a building a new docker image for it and it creates a table called books and has persistent volumes for our data.</p>
<pre><code>FROM postgres:12.16-bullseye

ENV POSTGRES_USER=admin
ENV POSTGRES_PASSWORD=admin
ENV POSTGRES_HOST=localhost

VOLUME [ &quot;/var/lib/postgresql/data&quot; ]
WORKDIR /
COPY init.sql /docker-entrypoint-initdb.d/

EXPOSE 5432do
</code></pre>
<p>Init.sql:</p>
<pre><code>CREATE TABLE book ( id SERIAL PRIMARY KEY, title VARCHAR(255), author VARCHAR(255), publication_date DATE );
</code></pre>
<p>After starting our containers, the application is working fine on our local machine :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*DKnpE7gOidyhxbCp" alt=""  />
</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*oUqw3qrINeO4rGHw" alt=""  />
</p>
<h3 id="writing-infrastructure-manifest-">Writing Infrastructure manifest :<a hidden class="anchor" aria-hidden="true" href="#writing-infrastructure-manifest-">#</a></h3>
<p>As we mentioned earlier, we will be provisioning a jenkins server and it will be also operating as ansible admin server.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*SGeQAHsJsPzx41jK" alt=""  />
</p>
<p>Finished writing infrastructure manifests :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*uoVwcvC9zKadiiXN" alt=""  />
</p>
<p>Now it is time to provision the jenkins main server which will execute our pipeline, for that i used also the IAC approach :</p>
<pre><code>terraform apply - auto-approve - var-file=terraform.tfvars
</code></pre>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*UF1RGBIERhVvqnKM" alt=""  />
</p>
<p>Now it is time to setup the jenkins server and install the appropriate plugins :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/3118/0*lzDFk6DCOvpjxWmm" alt=""  />
</p>
<p>We need to setup our AWS access tokens in the machine so it can apply the manifest files:</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2104/0*upsECL4EKhjVNJhD" alt=""  />
</p>
<h3 id="configuring-aws-ecr-">Configuring aws ECR :<a hidden class="anchor" aria-hidden="true" href="#configuring-aws-ecr-">#</a></h3>
<p>Amazon Elastic Container Registry (Amazon ECR) is a fully managed container registry offering high-performance hosting, so you can reliably deploy application images and artifacts anywhere.</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2726/0*pU-jwCzR0gBzxQ0z" alt=""  />
</p>
<p>We create the private repository :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*MRzhKYrGDamOwraH" alt=""  />
</p>
<h3 id="pushign-images-to-ecr-">Pushign images to ECR :<a hidden class="anchor" aria-hidden="true" href="#pushign-images-to-ecr-">#</a></h3>
<p>To push our local images to the repository that we have previously created, we need to tag the image like the following :</p>
<pre><code>Docker tag local_image_name repo_name:local_image
</code></pre>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2096/0*aesQ0qJtmbjZWD-D" alt=""  />
</p>
<p>Database :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2312/0*IGu9owxZK2pjTVR8" alt=""  />
</p>
<p>Now for ansible to connect to machine, we need to copy the private key to the jenkins server :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*99ugvog6ioqY7gpI" alt=""  />
</p>
<p>One more thing we needed to do is copying manually the vars.yaml file from our machine to the jenkins server because it contains vulnerable credentials and it cannot be pushed to git:</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*5SVNAcZ2O6-Z9a_O" alt=""  />
</p>
<p>After a lot of troubleshooting and tweaking of the ansible playbook, our pipeline executed successfully :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*atzFCCJFQ9b8azGY" alt=""  />
</p>
<p>Our playbook consists of installing required packages, installing docker and aws cli, and finally connecting docker to our private repository :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*L4pWjMZdXpfdV4hR" alt=""  />
</p>
<p>We can now access our Flask application located on the first machine, it seems working perfectly :</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*UXBQKpOMC3Pi9OCo" alt=""  />
</p>
<p><img loading="lazy" src="https://cdn-images-1.medium.com/max/2000/0*EhMZZTx0WJAlVDGQ" alt=""  />
</p>
<p>Before closing up, i want to explain a stage in our pipeline :</p>
<pre><code> stage(&quot;Adding public IPs to /etc/hosts&quot;) {
      steps {
        dir(&quot;./Infrastructure/EC2/&quot;) {
          sh &quot;terraform output &gt; file.txt&quot;
          sh &quot;cut -d '=' -f 2 file.txt&quot;
          sh &quot;sed 's/\&quot;//g; s/=//g' file.txt &gt; res.txt&quot;
          sh 'awk \' { t = $1; $1 = $2; $2 = t; print; } \' res.txt &gt; f.txt'
          sh &quot;cat f.txt&quot;
          sh 'sudo -- sh -c &quot;cat f.txt &gt;&gt; /etc/hosts&quot;'
        }
      }
    }
</code></pre>
<p>This little script takes the two ip addresses of the EC2s from the terraform output and it concatenates them into /etc/hosts file as :</p>
<pre><code>ip_address hostname
</code></pre>
<p>So ansible can resolve ip-one and ip-two to their correct addresses.</p>
<hr>
<p>Was this helpful?</p>
<p>Confusing?</p>
<p>If you have any questions, feel free to comment below!</p>
<p>Before you leave:</p>
<p>üëè Clap for the story</p>
<p>üì∞ Subscribe for more posts like this <a href="https://medium.com/@malek.zaag">@malek.zaag</a> ‚ö°Ô∏è</p>
<p>üëâüëà Please follow me: <a href="https://github.com/Malek-Zaag">GitHub</a> | <a href="https://www.linkedin.com/in/malekzaag/">LinkedIn</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://malek-zaag.netlify.app/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://malek-zaag.netlify.app/tags/aws/">AWS</a></li>
      <li><a href="https://malek-zaag.netlify.app/tags/automation/">Automation</a></li>
      <li><a href="https://malek-zaag.netlify.app/tags/jenkins/">Jenkins</a></li>
      <li><a href="https://malek-zaag.netlify.app/tags/ci-cd-pipeline/">Ci Cd pipeline</a></li>
    </ul>

<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on twitter"
        href="https://twitter.com/intent/tweet/?text=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS&amp;url=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f&amp;hashtags=Kubernetes%2cAWS%2cAutomation%2cJenkins%2cCiCdpipeline">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f&amp;title=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS&amp;summary=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS&amp;source=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f&title=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on whatsapp"
        href="https://api.whatsapp.com/send?text=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS%20-%20https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Automating Deployment using Jenkins,Ansible and AWS on telegram"
        href="https://telegram.me/share/url?text=Automating%20Deployment%20using%20Jenkins%2cAnsible%20and%20AWS&amp;url=https%3a%2f%2fmalek-zaag.netlify.app%2fblog%2faws-automated-pipeline%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://malek-zaag.netlify.app/">Malek Zaag</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
